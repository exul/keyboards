units:
  # choc v1 switches
  $default_width: U
  $default_height: U

  # space between columns (spread)
  ks: U+0.1

  # space between rows (padding)
  kp: U+0.1

  # min. distance between copper and the edge of the board
  battery_switch_edge_clearance: 0.4

  # switch dimensions - source: http://www.kailh.com/en/Products/Ks/CS/755.html
  switch_width: 14
  switch_height: 14
  switch_hole_extra_spacing: 0.7

  # mcu (Seeed Studio XIAO nRF52840) dimensions - source: https://www.seeedstudio.com/Seeed-XIAO-BLE-nRF52840-p-5201.html
  mcu_width: 17.5
  mcu_length: 21
  mcu_width_clerance: 1
  mcu_length_clerance: 3
  mcu_to_key_clearance: 2

  # cutout on the pcb to mount the mcu face down
  mcu_pcb_cutout_width: 12.9
  mcu_pcb_cutout_length: mcu_length + mcu_length_clerance

  # height/width of the battery switch: source: https://cdn.shopify.com/s/files/1/0618/5674/3655/files/ALPS-SSSS811101.pdf?v=1670451309
  battery_switch_height: 4
  battery_switch_width: 2.9
  battery_switch_length: 8

  # width of the reset switch: https://cdn.shopify.com/s/files/1/0618/5674/3655/files/PANASONIC-EVQPUC02K.pdf?v=1670451309
  reset_switch_width: 3.5

  # thumb key positons and rotation settings - source: https://github.com/nmunnich/ripple-thumb-keycaps?tab=readme-ov-file#design-guidelines
  thumb_middle_x_offset: 17
  thumb_middle_y_offset: 0
  thumb_middle_rotation: -7
  thumb_outer_x_offset: 37
  thumb_outer_y_offset: 4
  thumb_outer_rotation: -13

  # extra space between index and middle finger
  index_spread: ks+1.5

  # move ring column up by this number to have a stagger for the pinky and outer column
  pinky_stagger: 0.4 kp

  # extra space between pinky and index finger
  pinky_spread: ks+0.5

  # rotete pinky and outer column by this number (minus for counter clock wise)
  pinky_splay: -4

  # move middle column up by this number to have a stagger for the ring column
  ring_stagger: 0.25kp

  # move index column down by this number to have a stagger for the middle column
  middle_stagger: 0.25kp

  # move inner column down by this number to have a stagger for the index column
  index_stagger: 0.25kp

  # shift the whole thumb cluster along the x axis
  thumb_x_shift: 3

  # shift the whole thumb cluster along the y axis
  thumb_y_shift: 35

  # rotate the whole thumb cluster
  thumb_cluster_rotate: -13

  # size of the mcu area
  mcu_area_width: 35

  # space between the pcb and the wall of the case
  pcb_to_case_wall_tolerance: 0.5

  # thickness of the wall
  wall_thickness: 1

  # thickness of the bottom case
  bottom_plate_thickness: 1

  # thickness of the top plate
  top_plate_thickness: 2

  # space between the bottom and the top plate of the case
  internal_distance_between_plates: 1.5

  # distance between the nice view's bottom edge and the GND via
  via_oled_GND_clearance: 3

  # battery cutout
  battery_cutout_width: 32
  battery_cutout_height: 43
  battery_cutout_x_shift_matrix_inner_bottom: 26.5
  battery_cutout_y_shift_matrix_inner_bottom: -9.5
  battery_cutout_rotation: 0

  # usb-c cutout
  usbc_height: internal_distance_between_plates # use 3.3, once nice nano position on PCB is fixed
  usbc_width: 9 # change to 9, once nice nano position on PCB is fixed
  usbc_length: 9
  usbc_jut: 2 # number of milimeters the usbc plag stucks out from the PCB

  # added thickness to the bottom to make the case more stable
  stability_height: 1

  # snap tolerance, extra space between the double wall from the top plate and the single wall of the bottom place, the smaller the tighter the fit of the snap is
  snap_tolerance: 0.0

  # how wide the empty space between the two snap walls is, this is the slot between the double wall on the bottom case
  snap_slot_width: 0.8+snap_tolerance/2
  # how wide the middle wall is, this is the wall of the bottom case, that goes into the snap slof of the top case
  snap_middle_wall_width: snap_slot_width-snap_tolerance/2
  # this ts the width of the inner wall of the double wall on the top case
  inner_snap_wall_width: snap_slot_width

  # height of the walls that are used to snap
  bottom_snap_wall_height: bottom_plate_thickness + internal_distance_between_plates+ stability_height/2
  # this is the height oft the inner wall of the double wall on the top case, the inner wall is doesn't go all the way to the bottom, making this higher will make the fit more snug
  top_inner_snap_wall_height: top_plate_thickness + internal_distance_between_plates + stability_height/2 
  # thickness of the wall incl. both snap walls, this is the wall on the top part of the case with the outer and the inner wall
  double_wall_width: wall_thickness+snap_slot_width+inner_snap_wall_width
  # space between the pcb and the case wall
  pcb_to_case_wall_tolerance_incl_snap_wall: pcb_to_case_wall_tolerance+snap_slot_width+inner_snap_wall_width

  # distance for the mirrored case (only relevant for the preview)
  mirror_distance: 2.5ks

  # outline helpers
  edge_to_key_distance: 3 # distance between the edge of the case and keys
  outer_to_index_x_distance: ks+pinky_spread+ks+index_spread+thumb_x_shift
  outer_to_outer_thumb_x_distance: outer_to_index_x_distance+thumb_x_shift+3ks
  left_to_right_x_distance: outer_to_outer_thumb_x_distance+2ks
  thumbs_cluster_top_right_corner_y_shift_matrix_inner_bottom: battery_cutout_y_shift_matrix_inner_bottom - battery_cutout_height/2 - 2

  # pcb & case helpers
  top_key_center_to_outer_case_wall_distance: 0.5kp+edge_to_key_distance+pcb_to_case_wall_tolerance+double_wall_width # this is the distance of any key of the top row to the edge of the case (y direction), which can be used to place componenets relative to the outer case wall

  switch_cutout_width: switch_width+switch_hole_extra_spacing
  switch_cutout_height: switch_height+switch_hole_extra_spacing

  mcu_position_x_shift_from_matrx_inner_top: 0.5ks+mcu_to_key_clearance+mcu_width/2 # 0.5ks+mcu_area_width-mcu_length/2
  mcu_position_y_shift_from_matrx_inner_top: 0.5kp+edge_to_key_distance-mcu_length/2 # 0.5kp+edge_to_key_distance-mcu_width/2-5

  mcu_bottom_cutout_length: mcu_length+pcb_to_case_wall_tolerance+2*mcu_length_clerance # only apply length clearance onece, since the front side (snap wall) should not be cut
  mcu_bottom_cutout_width: mcu_width+2*mcu_width_clerance
  mcu_bottom_cutout_y_shift_from_matrx_inner_top: top_key_center_to_outer_case_wall_distance-double_wall_width-mcu_bottom_cutout_length/2 # subtract "mcu_length_clerance/2" to move the cutout away from the snap wall

  usbc_cutout_length: usbc_length+double_wall_width-usbc_jut
  usbc_cutout_width: usbc_width
  usbc_cutout_y_shift_from_matrix_inner_top: top_key_center_to_outer_case_wall_distance-usbc_cutout_length/2

   # offset of the solder pads (moving the solder pads outside of the mcu to be able cutout the PBC of the inner part of the mcu)
  x_offset_left_pads: 19.4
  y_offset_right_pads: 1.5
  x_offset_right_pads: 14.4
  y_offset_left_pads: 1.5

  jumper_pads_width: 10
  jumper_pads_length: mcu_length
  x_distance_between_mcu_and_jumper_pads: 5
  jumper_pads_cutout_x_shift_from_matrx_inner_top: mcu_position_x_shift_from_matrx_inner_top+mcu_width/2+jumper_pads_width/2+x_distance_between_mcu_and_jumper_pads
  jumper_pads_cutout_y_shift_from_matrix_inner_top: top_key_center_to_outer_case_wall_distance-double_wall_width-jumper_pads_length/2

  battery_switch_shift_x_from_matrix_inner_home: 0.5ks+mcu_area_width-battery_switch_width/2-battery_switch_edge_clearance
  battery_switch_shift_y_from_matrix_inner_home: 1.25

  battery_switch_wall_cutout_width: battery_switch_length+1
  battery_switch_wall_cutout_length: battery_switch_width+double_wall_width+battery_switch_edge_clearance+pcb_to_case_wall_tolerance_incl_snap_wall
  battery_switch_wall_cutout_shift_x_from_matrix_inner_home: battery_switch_shift_x_from_matrix_inner_home+(double_wall_width+pcb_to_case_wall_tolerance_incl_snap_wall+battery_switch_edge_clearance)
  battery_switch_wall_cutout_shift_y_from_matrix_inner_home: battery_switch_shift_y_from_matrix_inner_home

  jstph_length: 7
  xiao_battery_pos_pad_shift_y_from_battery_cutout: 2
  battery_raw_pads_shift_y_from_battery_cutout: 2
  xiao_battery_pos_pad_shift_x_from_matrix_inner_bottom: battery_cutout_x_shift_matrix_inner_bottom - battery_cutout_width/2 + battery_cutout_width/2
  xiao_battery_pos_pad_shift_y_from_matrix_inner_bottom: battery_cutout_y_shift_matrix_inner_bottom+battery_cutout_height/2+xiao_battery_pos_pad_shift_y_from_battery_cutout

  battery_raw_pos_pad_shift_x_from_matrix_inner_bottom: battery_cutout_x_shift_matrix_inner_bottom - battery_cutout_width/2 + battery_cutout_width*2/3
  battery_raw_pos_pad_shift_y_from_matrix_inner_bottom: battery_cutout_y_shift_matrix_inner_bottom-battery_cutout_height/2-battery_raw_pads_shift_y_from_battery_cutout

  battery_raw_neg_pad_shift_x_from_matrix_inner_bottom: battery_cutout_x_shift_matrix_inner_bottom - battery_cutout_width/2 + battery_cutout_width*1/3
  battery_raw_neg_pad_shift_y_from_matrix_inner_bottom: battery_cutout_y_shift_matrix_inner_bottom-battery_cutout_height/2-battery_raw_pads_shift_y_from_battery_cutout

  via_battery_raw_neg_shift_x_from_matrix_inner_bottom: battery_cutout_x_shift_matrix_inner_bottom - battery_cutout_width/2 + battery_cutout_width/2
  via_battery_raw_neg_shift_y_from_matrix_inner_bottom: battery_cutout_y_shift_matrix_inner_bottom-battery_cutout_height/2-battery_raw_pads_shift_y_from_battery_cutout

  battery_cable_cutout_top_width: 20
  battery_cable_cutout_top_length: 12
  battery_cable_cutout_top_shift_x_from_matrix_inner_top: xiao_battery_pos_pad_shift_x_from_matrix_inner_bottom
  battery_cable_cutout_top_shift_y_from_matrix_inner_top: battery_cutout_y_shift_matrix_inner_bottom + battery_cutout_height/2 + battery_cable_cutout_top_length/2

  battery_cable_cutout_bottom_overlap_with_battery_cutout: 2
  battery_cable_cutout_bottom_width: battery_cutout_width*7/8
  battery_cable_cutout_bottom_length: 10
  battery_cable_cutout_bottom_shift_x_from_matrix_inner_top: xiao_battery_pos_pad_shift_x_from_matrix_inner_bottom-battery_cable_cutout_bottom_width*1/5
  battery_cable_cutout_bottom_shift_y_from_matrix_inner_top: battery_cutout_y_shift_matrix_inner_bottom - battery_cutout_height/2 - battery_cable_cutout_bottom_length/2+battery_cable_cutout_bottom_overlap_with_battery_cutout

points:
  key:
    padding: kp
    spread: ks
  zones:
    matrix:
      mirror:
        ref: matrix_inner_home
        shift: mirror_distance
      key:
        tags:
          - key
      columns:
        outer:
          key:
            column_net: P6
            splay: -pinky_splay # apply negative pinky splay to keep the pinky and outer column at the same angle
        pinky:
          key:
            column_net: P5
        ring:
          key:
            column_net: P4
            splay: pinky_splay
            spread: pinky_spread
            stagger: pinky_stagger
        middle:
          key:
            column_net: P3
            stagger: ring_stagger
        index:
          key:
            column_net: P2
            spread: index_spread
            stagger: -middle_stagger
        inner:
          key:
            column_net: P1
            stagger: -index_stagger
      rows:
        bottom:
          row_net: P9
        home:
          row_net: P8
        top:
          row_net: P7
    thumbs:
      mirror:
        ref: matrix_inner_home
        shift: mirror_distance
      anchor:
        ref: matrix_index_bottom
        shift: [thumb_x_shift, -thumb_y_shift]
        rotate: thumb_cluster_rotate
      key:
        width: 1.5ks
        tags:
          - key
      columns:
        home:
          key:
            rotate: thumb_middle_rotation
            shift: [thumb_middle_x_offset, -thumb_middle_y_offset]
            column_net: P5
        outer:
          key:
            shift: [-ks+thumb_outer_x_offset, -thumb_outer_y_offset]
            rotate: thumb_outer_rotation
            column_net: P6
      rows:
        cluster:
          row_net: P10
    matrix_bottom_left_corner:
      mirror:
        ref: matrix_inner_home
        shift: mirror_distance
      anchor:
        - ref: matrix_outer_bottom
          shift: [-0.5ks-edge_to_key_distance, -0.5kp-edge_to_key_distance]
    thumbs_cluster_top_left_corner:
      mirror:
        ref: matrix_inner_home
        shift: mirror_distance
      anchor:
        - ref: matrix_outer_bottom
          shift:
            [
              0.5ks-edge_to_key_distance+outer_to_index_x_distance,
              -0.5kp-edge_to_key_distance,
            ]
    thumbs_cluster_bottom_left_corner:
      mirror:
        ref: matrix_inner_home
        shift: mirror_distance
      anchor:
        - ref: thumbs_home_cluster
          shift: [-0.5ks-edge_to_key_distance, -0.5kp-edge_to_key_distance]
    thumbs_cluster_bottom_right_corner:
      mirror:
        ref: matrix_inner_home
        shift: mirror_distance
      anchor:
        - ref: thumbs_outer_cluster
          shift: [0.5ks+edge_to_key_distance, -0.5kp-edge_to_key_distance]
    thumbs_cluster_top_right_corner:
      mirror:
        ref: matrix_inner_home
        shift: mirror_distance
      anchor:
        - ref: matrix_inner_bottom
          shift: [0.5ks+mcu_area_width, thumbs_cluster_top_right_corner_y_shift_matrix_inner_bottom]
    matrix_top_right_corner:
      mirror:
        ref: matrix_inner_home
        shift: mirror_distance
      anchor:
        - ref: matrix_inner_top
          shift: [0.5ks+mcu_area_width, 0.5kp+edge_to_key_distance]
    matrix_top_inner_left:
      mirror:
        ref: matrix_inner_home
        shift: mirror_distance
      anchor:
        - ref: matrix_inner_top
          shift: [-0.5ks, 0.5kp+edge_to_key_distance]
    matrix_top_index_right:
      mirror:
        ref: matrix_inner_home
        shift: mirror_distance
      anchor:
        - ref: matrix_index_top
          shift:
            [0.5ks, 0.5kp+(ring_stagger+middle_stagger)/2+edge_to_key_distance]
    matrix_top_ring_left:
      mirror:
        ref: matrix_inner_home
        shift: mirror_distance
      anchor:
        - ref: matrix_ring_top
          shift:
            [-0.5ks, 0.5kp+(ring_stagger+middle_stagger)/2+edge_to_key_distance]
    matrix_top_pinky_right:
      mirror:
        ref: matrix_inner_home
        shift: mirror_distance
      anchor:
        - ref: matrix_pinky_top
          shift: [0.5ks, 0.5kp+edge_to_key_distance]
    matrix_top_pinky_left:
      mirror:
        ref: matrix_inner_home
        shift: mirror_distance
      anchor:
        - ref: matrix_pinky_top
          shift: [-0.5ks, 0.5kp+edge_to_key_distance]
    matrix_top_left_corner:
      mirror:
        ref: matrix_inner_home
        shift: mirror_distance
      anchor:
        - ref: matrix_outer_top
          shift: [-0.5ks-edge_to_key_distance, 0.5kp+edge_to_key_distance]

outlines:
  # the socket outline/cutout is copied from https://github.com/ctranstrum/chuck
  _socket_outline:
    - what: rectangle
      adjust.shift: [0, -5.95]
      size: [4.75, 4.65]
      bevel: 1
    - what: rectangle
      adjust.shift: [-4.85, -3.8]
      size: [4.85, 4.65]
      fillet: 1
    - what: rectangle
      size: 2.6
      adjust.shift: [-2.4, -4.8]
    - what: rectangle
      adjust.shift: [-1.4, -2.5]
      size: 2.3
    - what: circle
      radius: 2.3
      adjust.shift: [-0.4, -1.35]
      operation: subtract
    - what: rectangle
      size: 2
      adjust.shift: [-2.375, -6.125]
    - what: circle
      radius: 1
      adjust.shift: [-3.375, -7.125]
      operation: subtract
    # right outer rectangle
    - what: rectangle
      size: [3.6, 1.7]
      adjust.shift: [2.375, -5.95]
    # left outer rectangle
    - what: rectangle
      size: [3.6, 1.7]
      adjust.shift: [-7.325, -3.8]
    - what: rectangle
      size: [2, 0.6]
      adjust.shift: [-6.5, -1.775]
    # middle hole
    - what: circle
      radius: 2
      adjust.shift: [0, 0]
    # added rectangle to cut out
    - what: rectangle
      size: 4
      adjust.shift: [0, -2.5]

  _socket_outlines:
    - what: outline
      name: _socket_outline
      where: key
      adjust:
        rotate: 90
        resist: true

  _socket_expanded:
    - what: outline
      name: _socket_outline
      expand: 0.6

  _socket_cutout:
    - what: outline
      name: _socket_expanded
      where: key

  _diode_cutout:
    - what: rectangle
      size: [6, 3]
      where: key
      adjust:
        shift: [0, 4.75]

  _jumper_pads_cutout:
    - what: rectangle
      where: matrix_inner_top
      size: [jumper_pads_width, jumper_pads_length]
      adjust:
        ref: matrix_inner_top
        shift:
          [
            jumper_pads_cutout_x_shift_from_matrx_inner_top,
            jumper_pads_cutout_y_shift_from_matrix_inner_top,
          ]

  _keys:
    - what: rectangle
      fillet: 2
      where: key
      bound: false
      size: [switch_cutout_width, switch_cutout_height]

  _board_left:
    - what: polygon
      fillet: 0.5
      points:
        - matrix_bottom_left_corner
        - thumbs_cluster_top_left_corner
        - thumbs_cluster_bottom_left_corner
        - thumbs_cluster_bottom_right_corner
        - thumbs_cluster_top_right_corner
        - matrix_top_right_corner
        - matrix_top_inner_left
        - matrix_top_index_right
        - matrix_top_ring_left
        - matrix_top_pinky_right
        - matrix_top_pinky_left
        - matrix_top_left_corner

  _plate_outline_left:
    - what: outline
      name: _board_left

  _case_outer_outline_left:
    - what: outline
      name: _plate_outline_left
      expand: wall_thickness + pcb_to_case_wall_tolerance_incl_snap_wall
      joints: 1

  _case_inner_outline_left:
    - what: outline
      name: _plate_outline_left
      expand: pcb_to_case_wall_tolerance_incl_snap_wall
      joints: 1

  _case_walls_left:
    - what: outline
      name: _case_outer_outline_left
    - what: outline
      name: _case_inner_outline_left
      operation: subtract

  _case_bottom_stability_outline_left:
    - what: outline
      name: _plate_outline_left
      expand: pcb_to_case_wall_tolerance-snap_slot_width
      joints: 1

  _case_bottom_snap_outer_outline_left:
    - what: outline
      name: _plate_outline_left
      expand: pcb_to_case_wall_tolerance_incl_snap_wall
      joints: 1

  _case_bottom_snap_inner_outline_left:
    - what: outline
      name: _plate_outline_left
      expand: pcb_to_case_wall_tolerance_incl_snap_wall-snap_middle_wall_width
      joints: 1

  _case_bottom_snap_left:
    - what: outline
      name: _case_bottom_snap_outer_outline_left
    - what: outline
      name: _case_bottom_snap_inner_outline_left
      operation: subtract

  _case_top_snap_outer_outline_left:
    - what: outline
      name: _plate_outline_left
      expand: pcb_to_case_wall_tolerance_incl_snap_wall-snap_slot_width
      joints: 1

  _case_top_snap_inner_outline_left:
    - what: outline
      name: _plate_outline_left
      expand: pcb_to_case_wall_tolerance_incl_snap_wall-snap_slot_width-inner_snap_wall_width
      joints: 1

  _case_top_snap_left:
    - what: outline
      name: _case_top_snap_outer_outline_left
    - what: outline
      name: _case_top_snap_inner_outline_left
      operation: subtract

  _mcu_pcb_cutout_left:
    - what: rectangle
      fillet: 2
      size: [mcu_pcb_cutout_width, mcu_pcb_cutout_length]
      where: matrix_inner_top
      adjust:
        shift:
          [
            mcu_position_x_shift_from_matrx_inner_top,
            mcu_position_y_shift_from_matrx_inner_top,
          ]

  _mcu_bottom_cutout_left:
    - what: rectangle
      where: matrix_inner_top
      size:
        [
          mcu_bottom_cutout_width,
          mcu_bottom_cutout_length,
        ]
      adjust:
        ref: matrix_inner_top
        shift:
          [
            mcu_position_x_shift_from_matrx_inner_top,
            mcu_bottom_cutout_y_shift_from_matrx_inner_top,
          ]

  _mcu_wall_cutout_left:
    - what: rectangle
      where: matrix_inner_top
      size: [usbc_cutout_width, usbc_cutout_length]
      adjust:
        ref: matrix_inner_top
        shift:
          [
            mcu_position_x_shift_from_matrx_inner_top,
            usbc_cutout_y_shift_from_matrix_inner_top,
          ]

  _usbc_cutout_left:
    - what: rectangle
      where: matrix_inner_top
      size: [usbc_cutout_width, usbc_cutout_length]
      adjust:
        ref: matrix_inner_top
        shift:
          [
            mcu_position_x_shift_from_matrx_inner_top,
            usbc_cutout_y_shift_from_matrix_inner_top,
          ]

  _battery_switch_wall_cutout_left:
    - what: rectangle
      where: matrix_inner_home
      size: [battery_switch_wall_cutout_length, battery_switch_wall_cutout_width]
      adjust:
        ref: matrix_inner_home
        shift:
          [
            battery_switch_wall_cutout_shift_x_from_matrix_inner_home,
            battery_switch_wall_cutout_shift_y_from_matrix_inner_home,
          ]

  _battery_cutout_left:
    - what: rectangle
      fillet: 2
      size: [battery_cutout_width, battery_cutout_height]
      where: matrix_inner_bottom
      adjust:
        shift:
          [
            battery_cutout_x_shift_matrix_inner_bottom,
            battery_cutout_y_shift_matrix_inner_bottom,
          ]
        rotate: battery_cutout_rotation

  _battery_cable_cutout_top_left:
    - what: rectangle
      where: matrix_inner_bottom
      size: [battery_cable_cutout_top_width, battery_cable_cutout_top_length]
      adjust:
        ref: matrix_inner_bottom
        shift:
          [
            battery_cable_cutout_top_shift_x_from_matrix_inner_top,
            battery_cable_cutout_top_shift_y_from_matrix_inner_top,
          ]

  _battery_cable_cutout_bottom_left:
    - what: rectangle
      where: matrix_inner_bottom
      size: [battery_cable_cutout_bottom_width, battery_cable_cutout_bottom_length]
      adjust:
        ref: matrix_inner_bottom
        shift:
          [
            battery_cable_cutout_bottom_shift_x_from_matrix_inner_top,
            battery_cable_cutout_bottom_shift_y_from_matrix_inner_top,
          ]

  board_preview_left:
    - name: _board_left
    - operation: subtract
      name: _keys
    - operation: subtract
      name: _mcu_pcb_cutout_left
    - operation: subtract
      name: _battery_cutout_left

  _board_right:
    - what: polygon
      fillet: 0.5
      points:
        - mirror_matrix_bottom_left_corner
        - mirror_thumbs_cluster_top_left_corner
        - mirror_thumbs_cluster_bottom_left_corner
        - mirror_thumbs_cluster_bottom_right_corner
        - mirror_thumbs_cluster_top_right_corner
        - mirror_matrix_top_right_corner
        - mirror_matrix_top_inner_left
        - mirror_matrix_top_index_right
        - mirror_matrix_top_ring_left
        - mirror_matrix_top_pinky_right
        - mirror_matrix_top_pinky_left
        - mirror_matrix_top_left_corner

  _plate_outline_right:
    - what: outline
      name: _board_right

  _case_outer_outline_right:
    - what: outline
      name: _plate_outline_right
      expand: wall_thickness + pcb_to_case_wall_tolerance_incl_snap_wall
      joints: 1

  _case_inner_outline_right:
    - what: outline
      name: _plate_outline_right
      expand: pcb_to_case_wall_tolerance_incl_snap_wall
      joints: 1

  _case_walls_right:
    - what: outline
      name: _case_outer_outline_right
    - what: outline
      name: _case_inner_outline_right
      operation: subtract

  _case_bottom_stability_outline_right:
    - what: outline
      name: _plate_outline_right
      expand: pcb_to_case_wall_tolerance-snap_slot_width
      joints: 1

  _case_bottom_snap_outer_outline_right:
    - what: outline
      name: _plate_outline_right
      expand: pcb_to_case_wall_tolerance_incl_snap_wall
      joints: 1

  _case_bottom_snap_inner_outline_right:
    - what: outline
      name: _plate_outline_right
      expand: pcb_to_case_wall_tolerance_incl_snap_wall-snap_middle_wall_width
      joints: 1

  _case_bottom_snap_right:
    - what: outline
      name: _case_bottom_snap_outer_outline_right
    - what: outline
      name: _case_bottom_snap_inner_outline_right
      operation: subtract

  _case_top_snap_outer_outline_right:
    - what: outline
      name: _plate_outline_right
      expand: pcb_to_case_wall_tolerance_incl_snap_wall-snap_slot_width
      joints: 1

  _case_top_snap_inner_outline_right:
    - what: outline
      name: _plate_outline_right
      expand: pcb_to_case_wall_tolerance_incl_snap_wall-snap_slot_width-inner_snap_wall_width
      joints: 1

  _case_top_snap_right:
    - what: outline
      name: _case_top_snap_outer_outline_right
    - what: outline
      name: _case_top_snap_inner_outline_right
      operation: subtract

  _mcu_pcb_cutout_right:
    - what: rectangle
      fillet: 2
      size: [mcu_pcb_cutout_width, mcu_pcb_cutout_length]
      where: mirror_matrix_inner_top
      adjust:
        shift:
          [
            mcu_position_x_shift_from_matrx_inner_top,
            mcu_position_y_shift_from_matrx_inner_top,
          ]

  _mcu_bottom_cutout_right:
    - what: rectangle
      where: mirror_matrix_inner_top
      size:
        [
          mcu_bottom_cutout_width,
          mcu_bottom_cutout_length,
        ]
      adjust:
        ref: mirror_matrix_inner_top
        shift:
          [
            mcu_position_x_shift_from_matrx_inner_top,
            mcu_bottom_cutout_y_shift_from_matrx_inner_top,
          ]

  _mcu_wall_cutout_right:
    - what: rectangle
      where: mirror_matrix_inner_top
      size: [usbc_cutout_width, usbc_cutout_length]
      adjust:
        ref: mirror_matrix_inner_top
        shift:
          [
            mcu_position_x_shift_from_matrx_inner_top,
            usbc_cutout_y_shift_from_matrix_inner_top,
          ]
  
  _usbc_cutout_right:
    - what: rectangle
      where: mirror_matrix_inner_top
      size: [usbc_cutout_width, usbc_cutout_length]
      adjust:
        ref: mirror_matrix_inner_top
        shift:
          [
            mcu_position_x_shift_from_matrx_inner_top,
            usbc_cutout_y_shift_from_matrix_inner_top,
          ]
  
  _battery_switch_wall_cutout_right:
    - what: rectangle
      where: mirror_matrix_inner_home
      size: [battery_switch_wall_cutout_length, battery_switch_wall_cutout_width]
      adjust:
        ref: mirror_matrix_inner_home
        shift:
          [
            battery_switch_wall_cutout_shift_x_from_matrix_inner_home,
            battery_switch_wall_cutout_shift_y_from_matrix_inner_home,
          ]

  _battery_cutout_right:
    - what: rectangle
      fillet: 2
      size: [battery_cutout_width, battery_cutout_height]
      where: mirror_matrix_inner_bottom
      adjust:
        shift:
          [
            battery_cutout_x_shift_matrix_inner_bottom,
            battery_cutout_y_shift_matrix_inner_bottom,
          ]
        rotate: battery_cutout_rotation

  _battery_cable_cutout_top_right:
    - what: rectangle
      where: mirror_matrix_inner_top
      size: [battery_cable_cutout_top_width, battery_cable_cutout_top_length]
      adjust:
        ref: mirror_matrix_inner_top
        shift:
          [
            battery_cable_cutout_top_shift_x_from_matrix_inner_top,
            battery_cable_cutout_top_shift_y_from_matrix_inner_top,
          ]
  
  _battery_cable_cutout_bottom_right:
    - what: rectangle
      where: mirror_matrix_inner_top
      size: [battery_cable_cutout_bottom_width, battery_cable_cutout_bottom_length]
      adjust:
        ref: mirror_matrix_inner_top
        shift:
          [
            battery_cable_cutout_bottom_shift_x_from_matrix_inner_top,
            battery_cable_cutout_bottom_shift_y_from_matrix_inner_top,
          ]

  board_preview_right:
    - name: _board_right
    - operation: subtract
      name: _keys
    - operation: subtract
      name: _mcu_pcb_cutout_right
    - operation: subtract
      name: _battery_cutout_right

  pcb_board:
    - name: _board_left
    - operation: subtract
      name: _mcu_pcb_cutout_left
    - operation: subtract
      name: _battery_cutout_left

cases:
  # the left top case uses the elements from the right side because negative extrudes are not possible, meaning everything is flipped
  left_case_top:
    - what: outline
      name: _case_outer_outline_right
      extrude: top_plate_thickness
    - what: outline
      name: _case_walls_right
      extrude: top_plate_thickness + internal_distance_between_plates + stability_height
    - what: outline
      name: _keys
      extrude: top_plate_thickness
      operation: subtract
    - what: outline
      name: _case_top_snap_right
      extrude: top_inner_snap_wall_height
      operation: add
    - what: outline
      name: _battery_cutout_right
      extrude: top_plate_thickness/2
      shift: [0, 0, top_plate_thickness/2]
      operation: subtract
    - what: outline
      name: _battery_switch_wall_cutout_left
      extrude: internal_distance_between_plates + stability_height
      shift: [0, 0, top_plate_thickness]
      operation: subtract
    - what: outline
      name: _mcu_bottom_cutout_right
      extrude: top_plate_thickness/2
      shift: [0, 0, top_plate_thickness/2]
      operation: subtract
    - what: outline
      name: _usbc_cutout_right
      extrude: top_plate_thickness + internal_distance_between_plates + stability_height
      operation: subtract
    - what: outline
      name: _jumper_pads_cutout
      extrude: top_plate_thickness/2
      shift: [0, 0, top_plate_thickness/2]
      operation: subtract
  
  left_case_bottom:
    - what: outline
      name: _case_outer_outline_left
      extrude: bottom_plate_thickness
    - what: outline
      name: _case_bottom_snap_left
      extrude: bottom_snap_wall_height
      operation: add
    - what: outline
      name: _case_bottom_stability_outline_left
      extrude: bottom_plate_thickness+stability_height
      operation: add
    - what: outline
      name: _battery_cutout_left
      extrude: internal_distance_between_plates+stability_height+bottom_plate_thickness/2
      shift: [0, 0, bottom_plate_thickness/2]
      operation: subtract
    - what:  outline
      name: _battery_cable_cutout_top_left
      extrude: internal_distance_between_plates+stability_height+bottom_plate_thickness/2
      shift: [0, 0, bottom_plate_thickness/2]
      operation: subtract
    - what:  outline
      name: _battery_cable_cutout_bottom_left
      extrude: internal_distance_between_plates+stability_height+bottom_plate_thickness/2
      shift: [0, 0, bottom_plate_thickness/2]
      operation: subtract
    - what: outline
      name: _battery_switch_wall_cutout_left
      extrude: internal_distance_between_plates+stability_height+bottom_plate_thickness
      operation: subtract
    - what: outline
      name: _mcu_wall_cutout_left
      extrude: internal_distance_between_plates+stability_height
      shift: [0, 0, bottom_plate_thickness]
      operation: subtract
    - what: outline
      name: _mcu_bottom_cutout_left
      extrude: bottom_snap_wall_height # has to have bottom_snap_wall_height because it also has to cut out the snap wall
      operation: subtract
    - what: outline
      name: _jumper_pads_cutout
      extrude: internal_distance_between_plates+stability_height+bottom_plate_thickness/2
      shift: [0, 0, bottom_plate_thickness/2]
      operation: subtract
    - what:  outline
      name: _diode_cutout
      extrude: internal_distance_between_plates+stability_height+bottom_plate_thickness/2
      shift: [0, 0, bottom_plate_thickness/2]
      operation: subtract
    - what:  outline
      name: _socket_cutout
      extrude: bottom_plate_thickness+stability_height
      operation: subtract

  # the right top case uses the elements from the left side because negative extrudes are not possible, meaning everything is flipped
  right_case_top:
    - what: outline
      name: _case_outer_outline_left
      extrude: top_plate_thickness
    - what: outline
      name: _case_walls_left
      extrude: top_plate_thickness + internal_distance_between_plates + stability_height
    - what: outline
      name: _keys
      extrude: top_plate_thickness
      operation: subtract
    - what: outline
      name: _case_top_snap_left
      extrude: top_inner_snap_wall_height
      operation: add
    - what: outline
      name: _battery_cutout_left
      extrude: top_plate_thickness/2
      shift: [0, 0, top_plate_thickness/2]
      operation: subtract
    - what: outline
      name: _battery_switch_wall_cutout_right
      extrude: internal_distance_between_plates + stability_height
      shift: [0, 0, top_plate_thickness]
      operation: subtract
    - what: outline
      name: _mcu_bottom_cutout_left
      extrude: top_plate_thickness/2
      shift: [0, 0, top_plate_thickness/2]
      operation: subtract
    - what: outline
      name: _usbc_cutout_left
      extrude: top_plate_thickness + internal_distance_between_plates + stability_height
      operation: subtract
    - what: outline
      name: _jumper_pads_cutout
      extrude: top_plate_thickness/2
      shift: [0, 0, top_plate_thickness/2]
      operation: subtract

  right_case_bottom:
    - what: outline
      name: _case_outer_outline_right
      extrude: bottom_plate_thickness
    - what: outline
      name: _case_bottom_snap_right
      extrude: bottom_snap_wall_height
      operation: add
    - what: outline
      name: _case_bottom_stability_outline_right
      extrude: bottom_plate_thickness+stability_height
      operation: add
    - what: outline
      name: _battery_cutout_right
      extrude: internal_distance_between_plates+stability_height+bottom_plate_thickness/2
      shift: [0, 0, bottom_plate_thickness/2]
      operation: subtract
    - what:  outline
      name: _battery_cable_cutout_top_right
      extrude: internal_distance_between_plates+stability_height+bottom_plate_thickness/2
      shift: [0, 0, bottom_plate_thickness/2]
      operation: subtract
    - what:  outline
      name: _battery_cable_cutout_bottom_right
      extrude: internal_distance_between_plates+stability_height+bottom_plate_thickness/2
      shift: [0, 0, bottom_plate_thickness/2]
      operation: subtract
    - what: outline
      name: _battery_switch_wall_cutout_left
      extrude: internal_distance_between_plates+stability_height+bottom_plate_thickness
      operation: subtract
    - what: outline
      name: _mcu_wall_cutout_right
      extrude: internal_distance_between_plates+stability_height
      shift: [0, 0, bottom_plate_thickness]
      operation: subtract
    - what: outline
      name: _mcu_bottom_cutout_right
      extrude: bottom_snap_wall_height # has to have bottom_snap_wall_height because it also has to cut out the snap wall
      operation: subtract
    - what:  outline
      name: _diode_cutout
      extrude: internal_distance_between_plates+stability_height+bottom_plate_thickness/2
      shift: [0, 0, bottom_plate_thickness/2]
      operation: subtract
    - what:  outline
      name: _socket_cutout
      extrude: bottom_plate_thickness+stability_height
      operation: subtract

pcbs:
  board:
    template: kicad8
    outlines:
      main:
        outline: pcb_board
    footprints:
      choc_hotswap:
        what: ergogen-footprints/switch_choc_v1_v2
        where: [[/^key/, /^matrix|^thumb/]]
        adjust:
          rotate: 180 # in case north facing LEDs are added
        params:
          reversible: true
          hotswap: true
          include_stabilizer_pad: false
          include_keycap: false
          keycap_height: cy
          keycap_width: cx
          from: "{{column_net}}"
          to: "{{colrow}}"
      diode:
        what: diode
        where: [[/^key/, /^matrix|^thumb/]]
        params:
          from: "{{colrow}}"
          to: "{{row_net}}"
        adjust:
          shift: [0, 5]
      mcu_seeed_xiao:
        what: ergogen-footprints/mcu_seeed_xiao
        where:
          ref: matrix_inner_top
          shift:
            [
              mcu_position_x_shift_from_matrx_inner_top,
              mcu_position_y_shift_from_matrx_inner_top,
            ]
          rotate: 0
        params:
          reversable: true
          reversable_pins: 7
          face_down: false
          x_offset_left_pads: x_offset_left_pads
          x_offset_right_pads: x_offset_right_pads
          y_offset_left_pads: y_offset_left_pads
          y_offset_right_pads: y_offset_right_pads
          reverse_solder_pads: true

      xiao_battery_pos_pad:
        what: ergogen-footprints/pad
        where:
          ref: matrix_inner_bottom
          shift: [
                xiao_battery_pos_pad_shift_x_from_matrix_inner_bottom,
                xiao_battery_pos_pad_shift_y_from_matrix_inner_bottom,
              ]
        params:
          net: BAT+
          text: BAT+

      battery_raw_pos_pad:
        what: ergogen-footprints/pad
        where:
          ref: matrix_inner_bottom
          shift: [
                battery_raw_pos_pad_shift_x_from_matrix_inner_bottom,
                battery_raw_pos_pad_shift_y_from_matrix_inner_bottom,
              ]
        params:
          net: RAW
          text: BAT+

      battery_raw_neg_pad:
        what: ergogen-footprints/pad
        where:
          ref: matrix_inner_bottom
          shift: [
                battery_raw_neg_pad_shift_x_from_matrix_inner_bottom,
                battery_raw_neg_pad_shift_y_from_matrix_inner_bottom,
              ]
        params:
          net: GND
          text: BAT-

      via_battery_raw_neg:
        what: via
        where:
          ref: matrix_inner_bottom
          shift:
            [
              via_battery_raw_neg_shift_x_from_matrix_inner_bottom,
              via_battery_raw_neg_shift_y_from_matrix_inner_bottom,
            ]
        params:
          net: GND

      battery_switch:
        what: ergogen-footprints/power_switch_smd_side
        where:
          ref: matrix_inner_home
          shift:
            [
              battery_switch_shift_x_from_matrix_inner_home,
              battery_switch_shift_y_from_matrix_inner_home,
            ]
        params:
          reversible: true
          invert_behavior: true
          from: BAT+
          to: RAW